<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Definir nueva contraseña</title>
</head>
<body class="bg-gradient-to-br from-red-600 to-blue-600 min-h-screen">
  <div class="flex min-h-full flex-col justify-center px-6 py-10 lg:px-8 mt-12">
    <div class="sm:mx-auto sm:w-full sm:max-w-xl">
      <h2 class="text-center text-3xl font-semibold text-white">Definir nueva contraseña</h2>
    </div>

    <div class="mt-6 sm:mx-auto sm:w-full sm:max-w-xl">
      {% if validlink %}
      <form method="post" class="space-y-5 bg-white/10 backdrop-blur-sm rounded-lg p-6">
        {% csrf_token %}

        {% if form.errors %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
          {% for field in form %}
            {% for error in field.errors %}<div>{{ error }}</div>{% endfor %}
          {% endfor %}
          {% for error in form.non_field_errors %}<div>{{ error }}</div>{% endfor %}
        </div>
        {% endif %}

        <!-- Nueva contraseña -->
        <div>
          <label class="block text-white font-semibold mb-1">Nueva contraseña</label>
          <div class="relative">
            <input id="new_password1" name="new_password1" type="password" required
                   class="block w-full rounded-md border-0 bg-white py-2 pl-3 pr-12 text-black shadow-sm ring-1 ring-inset ring-red-500 focus:ring-2 focus:ring-inset focus:ring-red-500" />
            <button type="button" id="togglePwd1"
                    class="absolute inset-y-0 right-0 px-3 text-gray-600 hover:text-gray-800"
                    aria-label="Mostrar u ocultar contraseña">
              <!-- ojo -->
              <svg id="icon1" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                   viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.478 0-8.268-2.943-9.542-7z"/>
                <circle cx="12" cy="12" r="3" stroke-width="2" stroke="currentColor" fill="none"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Confirmar contraseña -->
        <div>
          <label class="block text-white font-semibold mb-1">Confirmar contraseña</label>
          <div class="relative">
            <input id="new_password2" name="new_password2" type="password" required
                   class="block w-full rounded-md border-0 bg-white py-2 pl-3 pr-12 text-black shadow-sm ring-1 ring-inset ring-red-500 focus:ring-2 focus:ring-inset focus:ring-red-500" />
            <button type="button" id="togglePwd2"
                    class="absolute inset-y-0 right-0 px-3 text-gray-600 hover:text-gray-800"
                    aria-label="Mostrar u ocultar contraseña">
              <svg id="icon2" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                   viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.478 0-8.268-2.943-9.542-7z"/>
                <circle cx="12" cy="12" r="3" stroke-width="2" stroke="currentColor" fill="none"/>
              </svg>
            </button>
          </div>
          <p id="matchMsg" class="mt-2 text-sm"></p>
        </div>

        <!-- Requisitos -->
        <div class="rounded-md bg-white/70 p-4">
          <p class="font-semibold text-gray-800 mb-2">Debe cumplir con:</p>
          <ul id="requirements" class="space-y-1 text-sm">
            <li data-rule="len"         class="flex items-center gap-2 text-gray-700"><span class="icon">⚪</span>Mínimo <strong>12</strong> caracteres</li>
            <li data-rule="upper"       class="flex items-center gap-2 text-gray-700"><span class="icon">⚪</span>Al menos una letra <strong>mayúscula</strong></li>
            <li data-rule="lower"       class="flex items-center gap-2 text-gray-700"><span class="icon">⚪</span>Al menos una letra <strong>minúscula</strong></li>
            <li data-rule="digit"       class="flex items-center gap-2 text-gray-700"><span class="icon">⚪</span>Al menos un <strong>número</strong></li>
            <li data-rule="special"     class="flex items-center gap-2 text-gray-700"><span class="icon">⚪</span>Un carácter <strong>especial</strong> (@, #, $, %, &amp;, etc.)</li>
          </ul>
        </div>

        <button id="submitBtn" type="submit" disabled
                class="w-full rounded-md bg-gradient-to-r from-red-800 to-red-600 px-3 py-2 text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:from-red-700 hover:to-red-500">
          Guardar contraseña
        </button>
      </form>
      {% else %}
        <div class="text-center text-white">
          <p class="text-lg">El enlace no es válido o ya fue utilizado.</p>
          <a href="{% url 'password_reset' %}" class="inline-block mt-6 underline underline-offset-2 text-white/90 hover:text-white">
            Solicitar un nuevo enlace
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <script>
    // Utilidad: alternar visibilidad
    function bindToggle(btnId, inputId, iconId) {
      const btn = document.getElementById(btnId);
      const input = document.getElementById(inputId);
      const icon = document.getElementById(iconId);
      btn.addEventListener('click', () => {
        const isPwd = input.type === 'password';
        input.type = isPwd ? 'text' : 'password';
        // Alterna ícono simple (ojo abierto/cerrado)
        icon.innerHTML = isPwd
          ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.478 0-8.268-2.943-9.542-7z"/>'
          : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.478 0-8.268-2.943-9.542-7z"/><circle cx="12" cy="12" r="3" stroke-width="2" stroke="currentColor" fill="none"/>';
      });
    }

    const pwd1 = document.getElementById('new_password1');
    const pwd2 = document.getElementById('new_password2');
    const submitBtn = document.getElementById('submitBtn');
    const matchMsg = document.getElementById('matchMsg');
    const reqList  = document.getElementById('requirements');

    bindToggle('togglePwd1', 'new_password1', 'icon1');
    bindToggle('togglePwd2', 'new_password2', 'icon2');

    // Reglas
    const rules = {
      len:     v => v.length >= 12,
      upper:   v => /[A-ZÁÉÍÓÚÑ]/.test(v),
      lower:   v => /[a-záéíóúñ]/.test(v),
      digit:   v => /\d/.test(v),
      special: v => /[^\w\s]/.test(v) // cualquier no alfanumérico
    };

    function updateRequirements() {
      const v = pwd1.value || '';
      let allOk = true;

      [...reqList.querySelectorAll('li')].forEach(li => {
        const rule = li.dataset.rule;
        const passed = rules[rule](v);
        li.classList.toggle('text-green-700', passed);
        li.classList.toggle('text-gray-700', !passed);
        li.querySelector('.icon').textContent = passed ? '✅' : '⚪';
        if (!passed) allOk = false;
      });

      // Coincidencia
      const match = v.length > 0 && v === pwd2.value;
      matchMsg.textContent   = !pwd2.value ? '' : (match ? 'Las contraseñas coinciden.' : 'Las contraseñas no coinciden.');
      matchMsg.className     = 'mt-2 text-sm ' + (match ? 'text-green-200' : 'text-red-200');

      // Habilitar botón
      submitBtn.disabled = !(allOk && match);
    }

    pwd1.addEventListener('input', updateRequirements);
    pwd2.addEventListener('input', updateRequirements);
    document.addEventListener('DOMContentLoaded', updateRequirements);
  </script>
</body>
</html>
