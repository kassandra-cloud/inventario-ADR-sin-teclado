{% extends 'base.html' %}
{% load static %}

{% block title %}Listado de Perfiles{% endblock %}

{# Sidebar como siempre #}
{% block sidebar %}
  <div class="relative z-50">{% include 'componentes/sidebar.html' %}</div>
{% endblock %}

{% block content %}

<div id="content" class="w-full max-w-screen-2xl mx-auto px-4 py-6 md:pl-72">

  <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 mb-4">
    Listado de Perfiles
  </h1>

  <div class="grid grid-cols-1 gap-3 md:grid-cols-3 items-start mb-6">
    <form method="get" class="col-span-1 md:col-span-2 grid grid-cols-1 gap-3">
      <div class="flex flex-col">
        <label for="search" class="font-semibold text-gray-700">Buscar</label>
        <div class="relative w-full md:max-w-[560px]">
          <input id="search" name="search" value="{{ request.GET.search|default:'' }}"
                 placeholder="Buscar por usuario, nombre, correo…" type="text"
                 class="block w-full rounded-sm bg-gray-200 px-3 py-2 pr-12 shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600">
          <button type="submit"
                  class="absolute inset-y-0 right-0 flex items-center px-3 bg-gradient-to-br from-red-600 to-red-900 text-white rounded-r-sm"
                  title="Buscar" aria-label="Buscar">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/>
            </svg>
          </button>
        </div>
      </div>

      {% if request.GET %}
      <div class="flex items-end">
        <a href="{% url request.resolver_match.url_name %}" class="text-sm text-gray-600 hover:underline">Limpiar</a>
      </div>
      {% endif %}
    </form>
  </div>

  {% if profiles_with_singular_groups %}

  {# --------- MÓVIL/TABLET (< md): CARDS --------- #}
  <div class="space-y-3 md:hidden">
    {% for p in profiles_with_singular_groups %}
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm overflow-hidden">
        <div class="px-4 py-2 flex items-center gap-3 bg-gradient-to-r
          {% if 'ADR' in p.singular_groups %} from-amber-600 to-amber-900 text-white
          {% elif 'Operador ADR' in p.singular_groups %} from-red-600 to-red-900 text-white
          {% elif 'Auxiliar Operador ADR' in p.singular_groups %} from-red-500 to-fuchsia-900 text-white
          {% elif 'Usuario' in p.singular_groups %} from-zinc-900 to-zinc-950 text-neutral-100
          {% else %} from-gray-500 to-gray-900 text-white
          {% endif %}">

          {% if p.profile.image and p.profile.image.name %}
            <img src="{{ p.profile.image.url }}" alt="{{ p.profile.user.username }}"
                 class="w-9 h-9 rounded-full object-cover ring-2 ring-white/40"
                 onerror='this.onerror=null; this.src="{% get_media_prefix %}default.png"'>
          {% else %}
            <img src="{% get_media_prefix %}default.png" alt="{{ p.profile.user.username }}"
                 class="w-9 h-9 rounded-full object-cover ring-2 ring-white/40">
          {% endif %}

          <div class="font-semibold text-sm">{{ p.profile.user.username }}</div>
        </div>
        <div class="p-4 text-[13px]">
          <dl class="grid grid-cols-2 gap-x-4 gap-y-1">
            <div><dt class="text-gray-500">Nombre</dt><dd class="text-gray-800 break-words">{{ p.profile.user.first_name|default:"—" }}</dd></div>
            <div><dt class="text-gray-500">Apellidos</dt><dd class="text-gray-800 break-words">{{ p.profile.user.last_name|default:"—" }}</dd></div>
            <div class="col-span-2"><dt class="text-gray-500">Email</dt><dd class="text-gray-800 break-words">{{ p.profile.user.email|default:"—" }}</dd></div>
            <div class="col-span-2"><dt class="text-gray-500">Grupos</dt><dd class="text-gray-800 break-words">{{ p.singular_groups|join:", " }}</dd></div>
          </dl>
          {% if group_name_singular == 'ADR' or group_name_singular == 'Operador ADR' %}
          <div class="mt-3">
            <a href="{% url 'profile_edit' p.profile.user.pk %}"
               class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium text-white bg-gradient-to-br from-gray-600 to-gray-900 hover:from-gray-500 hover:to-gray-800 shadow-md">
              Editar
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  {# --------- ESCRITORIO / NOTEBOOK (>= md): TABLA --------- #}
  <div class="hidden md:block">
    <div class="relative overflow-x-auto rounded shadow ring-1 ring-black/5">
      <table class="w-full bg-white table-fixed min-w-[840px] lg:min-w-[1000px] xl:min-w-full">
        <thead class="bg-red-600 text-white text-xs md:text-sm sticky top-0 z-10">
          <tr>
            {# Imagen: sólo desde lg #}
            <th class="px-2 py-2 text-center w-14 hidden lg:table-cell">Imagen</th>
            <th class="px-2 py-2 text-left w-40">Usuario</th>
            <th class="px-2 py-2 text-left w-48">Nombre</th>
            {# Apellidos: sólo desde xl #}
            <th class="px-2 py-2 text-left w-48 hidden xl:table-cell">Apellidos</th>
            <th class="px-2 py-2 text-left w-64">Email</th>
            <th class="px-2 py-2 text-left">Grupo</th>
            {% if group_name_singular == 'ADR' or group_name_singular == 'Operador ADR' %}
              <th class="px-2 py-2 text-center w-24">Modificar</th>
            {% endif %}
          </tr>
        </thead>

        <tbody class="text-xs md:text-sm">
          {% for r in profiles_with_singular_groups %}
          <tr class="border-b border-neutral-100
            {% if 'Usuario' in r.singular_groups %} bg-zinc-950 text-neutral-100
            {% elif 'ADR' in r.singular_groups %} bg-gradient-to-tr from-amber-600 to-amber-900 text-white
            {% elif 'Operador ADR' in r.singular_groups %} bg-gradient-to-tr from-red-600 to-red-900 text-white
            {% elif 'Auxiliar Operador ADR' in r.singular_groups %} bg-gradient-to-tr from-red-500 to-fuchsia-900 text-white
            {% elif 'Alumno en Práctica' in r.singular_groups %} bg-gradient-to-tr from-gray-500 to-gray-900 text-white
            {% endif %}">
            
            {# Imagen: sólo desde lg #}
            <td class="px-2 py-1 text-center hidden lg:table-cell">
              {% if r.profile.image and r.profile.image.name %}
                <img src="{{ r.profile.image.url }}" alt="{{ r.profile.user.username }}"
                     class="w-9 h-9 object-cover rounded-full mx-auto ring-2 ring-white/40"
                     onerror='this.onerror=null; this.src="{% get_media_prefix %}default.png"'>
              {% else %}
                <img src="{% get_media_prefix %}default.png" alt="{{ r.profile.user.username }}"
                     class="w-9 h-9 object-cover rounded-full mx-auto ring-2 ring-white/40">
              {% endif %}
            </td>

            <td class="px-2 py-1 text-left truncate" title="{{ r.profile.user.username|capfirst }}">
              {{ r.profile.user.username|capfirst }}
            </td>

            <td class="px-2 py-1 text-left truncate" title="{{ r.profile.user.first_name|capfirst }}">
              {{ r.profile.user.first_name|capfirst }}
            </td>

            {# Apellidos: sólo desde xl #}
            <td class="px-2 py-1 text-left truncate hidden xl:table-cell"
                title="{{ r.profile.user.last_name|capfirst }}">
              {{ r.profile.user.last_name|capfirst }}
            </td>

            <td class="px-2 py-1 text-left whitespace-normal break-words">
              <span class="block max-w-[22ch] md:max-w-[28ch] lg:max-w-[36ch] xl:max-w-none truncate"
                    title="{{ r.profile.user.email }}">
                {{ r.profile.user.email }}
              </span>
            </td>

            <td class="px-2 py-1 text-left whitespace-normal break-words">
              <span class="block max-w-[24ch] md:max-w-[32ch] lg:max-w-[40ch] xl:max-w-none truncate"
                    title="{{ r.singular_groups|join:', ' }}">
                {{ r.singular_groups|join:", " }}
              </span>
            </td>

            {% if group_name_singular == 'ADR' or group_name_singular == 'Operador ADR' %}
            <td class="px-2 py-1 text-center">
              <a href="{% url 'profile_edit' r.profile.user.pk %}"
                 class="inline-flex items-center gap-1 px-2 py-1 md:px-3 md:py-1 rounded-full text-xs md:text-sm font-medium text-white bg-gradient-to-br from-gray-600 to-gray-900 hover:from-gray-500 hover:to-gray-800 shadow-md">
                Editar
              </a>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% include 'componentes/pagination.html' with add_url='add_user' nombre_activo='Usuario' %}
  {% endif %}
</div>
{% endblock content %}
