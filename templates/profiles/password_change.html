{% extends 'base.html' %}
{% load static %}

{% block title %}Cambiar contraseña{% endblock %}

{% block content %}
<div class="relative min-h-screen">
  <div class="ml-64 mx-auto">
    <div class="grid grid-cols-1 md:grid-cols-[320px,1fr] gap-6 md:gap-8">

      {# --- Photocard solo desktop --- #}
      <aside class="hidden md:block sticky top-20 self-start mt-24">
        <div class="rounded-xl overflow-hidden shadow-xl ring-1 ring-black/10 bg-white">
          {% if user.profile.image and user.profile.image.name %}
            <img class="w-full h-auto object-cover"
                 src="{{ user.profile.image.url }}" alt="{{ user.username }}"
                 onerror='this.onerror=null; this.src="{% get_media_prefix %}default.png"'/>
          {% else %}
            <img class="w-full h-auto object-cover"
                 src="{% get_media_prefix %}default.png" alt="{{ user.username }}"/>
          {% endif %}
        </div>
      </aside>

      {# --- FORMULARIO (card) --- #}
      <form method="post"
            class="p-6 md:p-8 bg-white rounded-xl shadow-2xl ring-1 ring-black/5 relative mt-24"
            id="pw-form">
        {% csrf_token %}

        {# Cabecera móvil (dentro del form) #}
        <header class="md:hidden mb-5 flex items-center gap-3">
          <div class="w-16 h-16 rounded-full overflow-hidden ring-2 ring-zinc-200 shrink-0">
            {% if user.profile.image and user.profile.image.name %}
              <img class="w-full h-full object-cover"
                   src="{{ user.profile.image.url }}" alt="{{ user.username }}"
                   onerror='this.onerror=null; this.src="{% get_media_prefix %}default.png"'/>
            {% else %}
              <img class="w-full h-full object-cover"
                   src="{% get_media_prefix %}default.png" alt="{{ user.username }}"/>
            {% endif %}
          </div>
          <div>
            <h2 class="text-zinc-800 text-xl font-semibold leading-tight">Cambiar contraseña</h2>
            <p class="text-zinc-500 text-sm">Actualiza tu contraseña de forma segura.</p>
          </div>
        </header>

        {# Título en desktop #}
        <h2 class="hidden md:block text-zinc-800 text-2xl font-semibold mb-6">Cambiar contraseña</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label class="block text-zinc-700 text-sm font-medium mb-1">Contraseña actual</label>
            <input type="password" name="old_password" autocomplete="current-password" required
                   class="w-full h-11 rounded-lg border border-zinc-300 px-3 bg-white"/>
            {% if form.old_password.errors %}
              <p class="text-xs text-red-600 mt-1">{% for e in form.old_password.errors %}{{ e }}{% endfor %}</p>
            {% endif %}
          </div>

          <div>
            <label class="block text-zinc-700 text-sm font-medium mb-1">Nueva contraseña</label>
            <input type="password" name="new_password1" id="new_password1" autocomplete="new-password"
                   minlength="12" required
                   class="w-full h-11 rounded-lg border border-zinc-300 px-3 bg-white"/>
            <p class="text-xs text-zinc-500 mt-1">Mínimo 12 caracteres.</p>
            {% if form.new_password1.errors %}
              <p class="text-xs text-red-600 mt-1">{% for e in form.new_password1.errors %}{{ e }}{% endfor %}</p>
            {% endif %}
          </div>

          <div>
            <label class="block text-zinc-700 text-sm font-medium mb-1">Confirmar nueva contraseña</label>
            <input type="password" name="new_password2" id="new_password2" autocomplete="new-password"
                   minlength="12" required
                   class="w-full h-11 rounded-lg border border-zinc-300 px-3 bg-white"/>
            {% if form.new_password2.errors %}
              <p class="text-xs text-red-600 mt-1">{% for e in form.new_password2.errors %}{{ e }}{% endfor %}</p>
            {% endif %}
          </div>
        </div>

        {# Checklist de requisitos #}
        <div class="mt-4 rounded-lg bg-zinc-50 border border-zinc-200 p-4">
          <p class="text-sm text-zinc-700 font-medium mb-2">La nueva contraseña debe cumplir:</p>
          <ul id="pw-reqs" class="text-sm space-y-1">
            <li id="req-length"  class="flex items-center gap-2 text-gray-500"><span class="status w-4 text-center">•</span>Mínimo 12 caracteres</li>
            <li id="req-upper"   class="flex items-center gap-2 text-gray-500"><span class="status w-4 text-center">•</span>Al menos una letra mayúscula</li>
            <li id="req-lower"   class="flex items-center gap-2 text-gray-500"><span class="status w-4 text-center">•</span>Al menos una letra minúscula</li>
            <li id="req-number"  class="flex items-center gap-2 text-gray-500"><span class="status w-4 text-center">•</span>Al menos un número</li>
            <li id="req-special" class="flex items-center gap-2 text-gray-500"><span class="status w-4 text-center">•</span>Un carácter especial (@, #, $, %, !, *)</li>
            <li id="req-match"   class="flex items-center gap-2 text-gray-500"><span class="status w-4 text-center">•</span>Las contraseñas coinciden</li>
          </ul>
        </div>

        {% if form.non_field_errors %}
          <div class="p-3 rounded border border-red-200 bg-red-50 text-red-700 text-sm mt-4">
            {% for e in form.non_field_errors %}{{ e }}{% endfor %}
          </div>
        {% endif %}

        {# Botones responsivos dentro del form #}
        <div class="mt-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <a href="{% url 'my_profile' %}"
             class="w-full md:w-auto text-center text-sm sm:text-base h-11 px-4 py-2
                    rounded-lg bg-zinc-700 text-white hover:bg-zinc-800 transition shadow">
            Volver a mi perfil
          </a>

          <button type="submit" id="pw-submit"
                  class="w-full md:w-auto text-center text-sm sm:text-base h-11 px-4 py-2
                         rounded-lg bg-red-900 text-white hover:bg-red-800 transition shadow
                         disabled:opacity-60 disabled:cursor-not-allowed whitespace-nowrap"
                  disabled>
            Guardar nueva contraseña
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{# JS: checklist en vivo #}
<script>
(function () {
  const p1 = document.getElementById('new_password1');
  const p2 = document.getElementById('new_password2');
  const submit = document.getElementById('pw-submit');

  const li = {
    length:  document.getElementById('req-length'),
    upper:   document.getElementById('req-upper'),
    lower:   document.getElementById('req-lower'),
    number:  document.getElementById('req-number'),
    special: document.getElementById('req-special'),
    match:   document.getElementById('req-match'),
  };

  function setOK(el, ok) {
    const dot = el.querySelector('.status');
    if (ok) {
      el.classList.remove('text-gray-500');
      el.classList.add('text-green-600');
      dot.textContent = '✓';
      dot.classList.add('text-green-600');
      dot.classList.remove('text-gray-500');
    } else {
      el.classList.add('text-gray-500');
      el.classList.remove('text-green-600');
      dot.textContent = '•';
      dot.classList.add('text-gray-500');
      dot.classList.remove('text-green-600');
    }
  }

  function refresh() {
    const v1 = p1.value || '';
    const v2 = p2.value || '';
    const ok = {
      length:  v1.length >= 12,
      upper:   /[A-Z]/.test(v1),
      lower:   /[a-z]/.test(v1),
      number:  /\d/.test(v1),
      special: /[@#$%^&*!]/.test(v1),
      match:   v1.length > 0 && v1 === v2,
    };
    setOK(li.length,  ok.length);
    setOK(li.upper,   ok.upper);
    setOK(li.lower,   ok.lower);
    setOK(li.number,  ok.number);
    setOK(li.special, ok.special);
    setOK(li.match,   ok.match);

    submit.disabled = !Object.values(ok).every(Boolean);
  }

  p1.addEventListener('input', refresh);
  p2.addEventListener('input', refresh);
  refresh();
})();
</script>
{% endblock %}
