{% extends 'base.html' %}
{% load static %}

{% block title %}Historial de Cambios{% endblock %}

{% block sidebar %}
<div class="contents">
  {% include 'componentes/sidebar.html' %}
</div>
{% endblock %}

{% block content %}
<div id="content" class="w-full max-w-screen-2xl mx-auto px-4 py-6 md:ml-72">
  <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 mb-4">Historial de Cambios</h1>

  {# --------- CONTROLES --------- #}
  <div class="grid grid-cols-1 gap-3 md:grid-cols-3 items-start mb-6">
    <form method="get" class="col-span-1 md:col-span-2 grid grid-cols-1 sm:grid-cols-[auto_auto_auto_auto] gap-3">
      <select id="usuario" name="usuario"
              class="rounded-sm bg-gray-200 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600"
              onchange="this.form.submit()">
        <option value="todos" {% if usuario_seleccionado == 'todos' %}selected{% endif %}>Todos los usuarios</option>
        {% for user in usuarios %}
          <option value="{{ user.username }}" {% if usuario_seleccionado == user.username %}selected{% endif %}>
            {{ user.get_full_name }} ({{ user.username }})
          </option>
        {% endfor %}
      </select>

      <input id="fecha_inicio" type="date" name="fecha_inicio" value="{{ fecha_inicio }}"
             class="rounded-sm bg-gray-200 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600"
             onchange="this.form.submit()">

      <input id="fecha_fin" type="date" name="fecha_fin" value="{{ fecha_fin }}"
             class="rounded-sm bg-gray-200 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-red-600"
             onchange="this.form.submit()">

      <div class="flex items-end">
        {% if request.GET %}
          <a href="{% url request.resolver_match.url_name %}" class="text-sm text-gray-600 hover:underline">Ver todos</a>
        {% endif %}
      </div>
    </form>

    {% if historial %}
    <div class="col-span-1 flex md:justify-end">
      <a href="{% url 'descargar_excel' 'historialcambios' %}"
         class="w-full sm:w-auto text-center bg-gradient-to-br from-green-600 to-green-900 hover:from-green-500 hover:to-green-700 text-white px-4 py-2 rounded shadow-sm">
        Descargar Excel
      </a>
    </div>
    {% endif %}
  </div>

  {% if historial %}

  {# ============ MÃ“VIL: TARJETAS ============ #}
  <div class="space-y-3 md:hidden">
    {% for c in historial %}
      <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
        <div class="flex items-start justify-between gap-2">
          <div class="font-semibold text-gray-900 text-sm">{{ c.usuario }}</div>
          <span class="px-2 py-0.5 rounded-full text-xs bg-neutral-100 text-neutral-800">
            {{ c.fecha_modificacion|date:"d-m-Y H:i" }}
          </span>
        </div>

        <dl class="mt-2 grid grid-cols-2 gap-x-4 gap-y-1 text-[13px]">
          <div><dt class="text-gray-500">Modelo</dt><dd class="text-gray-800 break-words">{{ c.modelo }}</dd></div>

          <div>
            <dt class="text-gray-500">ID Objeto</dt>
            <dd class="text-gray-800 break-all">
              {% if c.objeto_id %}
                {% with c.modelo|lower as modelo %}
                  {% if modelo == 'allinone' %}
                    <a class="text-blue-600 underline" href="{% url 'all_in_one' %}?search={{ c.objeto_id }}&search_by_pk=true">{{ c.objeto_id }}</a>
                  {% elif modelo == 'allinoneadmins' %}
                    <a class="text-blue-600 underline" href="{% url 'all_in_one_adm' %}?search={{ c.objeto_id }}&search_by_pk=true">{{ c.objeto_id }}</a>
                  {% elif modelo == 'notebook' %}
                    <a class="text-blue-600 underline" href="{% url 'notebooks' %}?search={{ c.objeto_id }}&search_by_pk=true">{{ c.objeto_id }}</a>
                  {% elif modelo == 'minipc' %}
                    <a class="text-blue-600 underline" href="{% url 'mini_pc' %}?search={{ c.objeto_id }}&search_by_pk=true">{{ c.objeto_id }}</a>
                  {% elif modelo == 'proyectores' %}
                    <a class="text-blue-600 underline" href="{% url 'proyectores' %}?search={{ c.objeto_id }}&search_by_pk=true">{{ c.objeto_id }}</a>
                  {% elif modelo == 'azotea' %}
                    <a class="text-blue-600 underline" href="{% url 'azotea_adr' %}?search={{ c.objeto_id }}&search_by_pk=true">{{ c.objeto_id }}</a>
                  {% elif modelo == 'bodegaadr' %}
                    <a class="text-blue-600 underline" href="{% url 'bodega_adr' %}?search={{ c.objeto_id }}&search_by_pk=true">{{ c.objeto_id }}</a>
                  {% else %}
                    {{ c.objeto_id }}
                  {% endif %}
                {% endwith %}
              {% else %}
                <span class="text-gray-500">Sin ID</span>
              {% endif %}
            </dd>
          </div>

          <div class="col-span-2"><dt class="text-gray-500">Campo modificado</dt><dd class="text-gray-800">{{ c.campo_modificado }}</dd></div>
          <div class="col-span-2"><dt class="text-gray-500">Valor anterior</dt><dd class="text-gray-800 break-words">{{ c.valor_anterior }}</dd></div>
          <div class="col-span-2"><dt class="text-gray-500">Valor nuevo</dt><dd class="text-gray-800 break-words">{{ c.valor_nuevo }}</dd></div>
        </dl>
      </div>
    {% empty %}
      <p class="text-center text-gray-500">No hay cambios registrados.</p>
    {% endfor %}
  </div>

  {# ============ ESCRITORIO: TABLA ============ #}
  <div class="hidden md:block">
    <div class="relative overflow-x-auto rounded shadow ring-1 ring-black/5">
      <table class="min-w-[1000px] w-full table-fixed bg-white">
        <thead class="bg-red-600 text-white text-sm sticky top-0 z-0">
          <tr>
            <th class="px-3 py-2 text-left min-w-[150px]">Usuario</th>
            <th class="px-3 py-2 text-left min-w-[150px]">Modelo</th>
            <th class="px-3 py-2 text-left min-w-[150px]">ID Objeto</th>
            <th class="px-3 py-2 text-left min-w-[150px]">Campo Modificado</th>
            <th class="px-3 py-2 text-left min-w-[180px]">Valor Anterior</th>
            <th class="px-3 py-2 text-left min-w-[180px]">Valor Nuevo</th>
            <th class="px-3 py-2 text-left min-w-[170px]">Fecha / Hora</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 text-sm">
          {% for c in historial %}
          <tr class="{% cycle 'bg-blue-50' 'bg-white' %} hover:bg-gray-50">
            <td class="px-3 py-2 text-gray-900">{{ c.usuario }}</td>
            <td class="px-3 py-2 text-gray-900">{{ c.modelo }}</td>
            <td class="px-3 py-2">
              {% if c.objeto_id %}
                {% with c.modelo|lower as modelo %}
                  {% if modelo == 'allinone' %}
                    <a href="{% url 'all_in_one' %}?search={{ c.objeto_id }}&search_by_pk=true" class="text-blue-600 underline">{{ c.objeto_id }}</a>
                  {% elif modelo == 'allinoneadmins' %}
                    <a href="{% url 'all_in_one_adm' %}?search={{ c.objeto_id }}&search_by_pk=true" class="text-blue-600 underline">{{ c.objeto_id }}</a>
                  {% elif modelo == 'notebook' %}
                    <a href="{% url 'notebooks' %}?search={{ c.objeto_id }}&search_by_pk=true" class="text-blue-600 underline">{{ c.objeto_id }}</a>
                  {% elif modelo == 'minipc' %}
                    <a href="{% url 'mini_pc' %}?search={{ c.objeto_id }}&search_by_pk=true" class="text-blue-600 underline">{{ c.objeto_id }}</a>
                  {% elif modelo == 'proyectores' %}
                    <a href="{% url 'proyectores' %}?search={{ c.objeto_id }}&search_by_pk=true" class="text-blue-600 underline">{{ c.objeto_id }}</a>
                  {% elif modelo == 'azotea' %}
                    <a href="{% url 'azotea_adr' %}?search={{ c.objeto_id }}&search_by_pk=true" class="text-blue-600 underline">{{ c.objeto_id }}</a>
                  {% elif modelo == 'bodegaadr' %}
                    <a href="{% url 'bodega_adr' %}?search={{ c.objeto_id }}&search_by_pk=true" class="text-blue-600 underline">{{ c.objeto_id }}</a>
                  {% else %}
                    {{ c.objeto_id }}
                  {% endif %}
                {% endwith %}
              {% else %}
                <span class="text-gray-500">Sin ID</span>
              {% endif %}
            </td>
            <td class="px-3 py-2">{{ c.campo_modificado }}</td>
            <td class="px-3 py-2 break-words">{{ c.valor_anterior }}</td>
            <td class="px-3 py-2 break-words">{{ c.valor_nuevo }}</td>
            <td class="px-3 py-2">{{ c.fecha_modificacion|date:"d-m-Y H:i:s" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="px-3 py-4 text-center text-gray-500">No hay cambios registrados</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% endif %}

  {% include 'componentes/paginationB.html' %}
</div>
{% endblock %}
