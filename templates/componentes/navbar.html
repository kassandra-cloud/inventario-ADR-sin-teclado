{% load static %}

{# ---------- Wrapper con color por rango ---------- #}
{% if user.is_authenticated %}
  {% with g=group_name_singular|default:"Usuario"|lower %}
    {% if g == "usuario" %}
      <nav class="fixed top-0 left-0 w-full h-12 md:h-14 z-[100] border-b border-black/5
                  bg-zinc-900 text-white backdrop-blur-sm">
    {% elif g == "adr" %}
      <nav class="fixed top-0 left-0 w-full h-12 md:h-14 z-[100] border-b border-black/5
                  bg-gradient-to-tr from-amber-600 to-amber-900 text-white backdrop-blur-sm">
    {% elif g == "operador adr" %}
      <nav class="fixed top-0 left-0 w-full h-12 md:h-14 z-[100] border-b border-black/5
                  bg-gradient-to-tr from-red-600 to-red-900 text-white backdrop-blur-sm">
    {% elif g == "auxiliar operador adr" %}
      <nav class="fixed top-0 left-0 w-full h-12 md:h-14 z-[100] border-b border-black/5
                  bg-gradient-to-tr from-red-500 to-fuchsia-900 text-white backdrop-blur-sm">
    {% elif g == "alumno en práctica" or g == "alumno en practica" or g == "alumnos en práctica" or g == "alumnos en practica" %}
      <nav class="fixed top-0 left-0 w-full h-12 md:h-14 z-[100] border-b border-black/5
                  bg-gradient-to-tr from-gray-500 to-gray-900 text-white backdrop-blur-sm">
    {% else %}
      <nav class="fixed top-0 left-0 w-full h-12 md:h-14 z-[100] border-b border-black/5
                  bg-gradient-to-tr from-red-700 to-red-900 text-white backdrop-blur-sm">
    {% endif %}
  {% endwith %}
{% else %}
  <nav class="fixed top-0 left-0 w-full h-12 md:h-14 z-[100] bg-zinc-900 text-white backdrop-blur-sm">
{% endif %}

  {# ---------- Contenido del navbar ---------- #}
  <div class="max-w-screen-2xl mx-auto px-2 sm:px-3 h-full flex items-center justify-between">

    {# Izquierda: hamburguesa + marca (corta en móvil) #}
    <div class="flex items-center gap-2">
      <button id="hamburgerButton"
              class="w-10 h-10 grid place-items-center rounded-md/2 focus:outline-none focus:ring-2 focus:ring-white/40">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>

      <h1 class="font-semibold leading-none truncate
                 text-sm sm:text-base max-w-[44vw] sm:max-w-[320px]">
        GESTIÓN INVENTARIO ADR
      </h1>
    </div>

    {# Derecha: info usuario + avatar + acciones #}
    <div class="flex items-center gap-2 sm:gap-3">

      {# Texto largo solo en md+ para evitar desbordes en móvil #}
      {% if user.is_authenticated %}
      <span class="hidden md:block text-sm italic truncate max-w-[32vw]">
        Usuario en línea: {{ user.first_name|capfirst }} {{ user.last_name|capfirst }} | {{ group_name_singular }}
      </span>
      {% endif %}

      {# Avatar con fallback a /media/default.png #}
      <a href="{% url 'my_profile' %}" title="Mi perfil"
         class="w-9 h-9 rounded-full overflow-hidden ring-1 ring-white/40 shrink-0">
        {% if user.is_authenticated and user.profile.image and user.profile.image.name %}
          <img class="w-full h-full object-cover"
               src="{{ user.profile.image.url }}"
               alt="{{ user.username }}"
               onerror='this.onerror=null; this.src="{% get_media_prefix %}default.png"'>
        {% else %}
          <img class="w-full h-full object-cover"
               src="{% get_media_prefix %}default.png"
               alt="{{ user.username }}">
        {% endif %}
      </a>

      {% if user.is_authenticated %}
        {# "Mi perfil" solo en md+; en móvil ya está el avatar clickeable #}
        <a href="{% url 'my_profile' %}"
           class="hidden md:inline-block text-xs md:text-sm font-semibold px-2 py-1 rounded hover:underline">
          Mi perfil
        </a>

        {# Botón salir: como icono en móvil, como botón en md+ #}
        <form method="POST" action="{% url 'logout' %}" class="m-0 p-0">
          {% csrf_token %}
          <button type="submit"
                  class="md:hidden w-10 h-10 grid place-items-center rounded-md/2 focus:outline-none focus:ring-2 focus:ring-white/40"
                  title="Cerrar sesión" aria-label="Cerrar sesión">
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M16 17l5-5-5-5v3H9v4h7v3z"></path>
              <path d="M4 4h7v2H6v12h5v2H4z"></path>
            </svg>
          </button>
          <button type="submit"
                  class="hidden md:inline-flex items-center text-white text-sm font-semibold px-3 py-2 rounded-md
                         bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-white/40 transition">
            Cerrar Sesión
          </button>
        </form>
      {% endif %}
    </div>
  </div>
</nav>

{# -------- JS: abre/cierra sidebar -------- #}
<script>
document.addEventListener('DOMContentLoaded', function () {
  if (window.navbarScriptInitialized) return;
  window.navbarScriptInitialized = true;

  const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
  if (!isAuthenticated) return;

  const hamburgerButton = document.getElementById('hamburgerButton');
  const sidebar = document.getElementById('sidebar');

  if (hamburgerButton && sidebar) {
    hamburgerButton.addEventListener('click', function (e) {
      e.stopPropagation();
      sidebar.classList.toggle('left-[-300px]');
      sidebar.classList.toggle('left-0');
    });

    document.addEventListener('click', function (e) {
      if (sidebar.classList.contains('left-0') &&
          !sidebar.contains(e.target) &&
          !hamburgerButton.contains(e.target)) {
        sidebar.classList.remove('left-0');
        sidebar.classList.add('left-[-300px]');
      }
    });
  }
});
</script>
